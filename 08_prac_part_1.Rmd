---
title: "R and spatial data: intermediate 1"
author: "Radoslaw Panczak"
date: 2019-02-26
output: 
  html_document: 
    # css: custom.css
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    theme: united 
    highlight: pygments 
---

# Maintenance 

## Start R session and Rstudio

You might want to continue using project from yesterday.

## Load the libraries

```{r}
set.seed(1234)

if (!require("tidyverse")) install.packages("tidyverse"); library("tidyverse")
if (!require("sf")) install.packages("sf"); library("sf")
if (!require("tmap")) install.packages("tmap"); library("tmap")
if (!require("tmaptools")) install.packages("tmaptools"); library("tmaptools")
if (!require("sjmisc")) install.packages("sjmisc"); library("sjmisc")

if (!require("skimr")) install.packages("skimr"); library("skimr")

```

# Data: SA2s and SEIFA

We will reuse data prepared yesterday.

## Code

```{r}
SA2_SEIFA <- readRDS("data/SA2_SEIFA.Rds")
```

# Data: Airbnb in Melbourne

## Background information

[Inside Airbnb](http://insideairbnb.com/about.html) is website that describes itself as:

> an independent, non-commercial set of tools and data that allows you to explore how Airbnb is really being used in cities around the world. By analyzing publicly available information about a city's Airbnb's listings, Inside Airbnb provides filters and key metrics so you can see how Airbnb is being used to compete with the residential housing market.

The dataset is not offically approved by Airbnb (!) but is released under open license and in the absence of other data - was used by many research projects around the world.

## Reading the data

### Code 

```{r}
listings <- read_csv("./data/listings.csv")
```

### Explanation

point to difference `csv`

## Examine the data

### Code 

```{r}
slice(listings, 1:5)
```

```{r, results='asis' }
skim(listings) %>% skimr::kable()
```

### Explanation

## Turning data spatial

### Code 

```{r}
listings_sf = st_as_sf(listings, coords = c("longitude", "latitude"), crs = 4326)
```

### Explanation

Look at the difference

```{r}
slice(listings_sf, 1:5)
```

http://spatialreference.org/ref/epsg/wgs-84/ 

## Map of locations

### Code 

```{r}
tmap_mode("view")

listings_sf %>% 
  sample_n(1000) %>% 
  qtm()
```

### Explanation

## Exploring attributes

Map variable in your data to visual encoding on map.

### Code 

```{r}
ggplot(listings_sf, aes(price)) + geom_histogram()
```

```{r}
descr(listings_sf$price)
```

```{r}
listings_sf %>% 
  ggplot(aes(room_type)) + geom_bar()
```

```{r}
listings_sf %>% 
  ggplot(aes(room_type, price)) + geom_boxplot() + scale_y_log10()
```


```{r}
listings_sf %>% 
  sample_n(1000) %>%
  tm_shape() + 
  tm_dots(col = "price", style = "quantile", n = 5, palette = "seq")
```

```{r}
listings_sf %>% 
  sample_n(1000) %>%
  tm_shape() + 
  tm_dots(col = "room_type", style = "cat", n = 5, palette = "seq")
```

# Mapping price density 

GDA_1994_Geoscience_Australia_Lambert
WKID: 3112 Authority: EPSG

GDA_1994_Australia_Albers
WKID: 3577 Authority: EPSG

## Data preparation

### Code 

### Explanation

## Density calculation

### Code 

### Explanation


```{r}
listings_sf_proj <- st_transform(listings_sf, 3112)

frq(listings_sf_proj$room_type)

outline <- SA2_SEIFA %>% st_union %>% st_transform(3112)

home_densities <- listings_sf_proj %>% 
  filter(room_type == "Entire home/apt") %>% 
  smooth_map(var = price, 
             cover = outline, 
             breaks = c(0, 1, 5, 10, 25, 50, 100, 250, 500, 1000))

room_densities <- listings_sf_proj %>% 
  filter(room_type == "Private room") %>% 
  smooth_map(var = price, 
             cover = outline, 
             breaks = c(0, 1, 5, 10, 25, 50, 100, 250, 500, 1000))

tm_shape(room_densities$polygons) +
  tm_fill(col = "level", palette = "YlOrRd", 
          title = expression("Room price"))

```



# Further topics

1. If room done - then hose or vice versa?

# Resources

Anselin, L. 1995. Local indicators of spatial association - LISA. Geographical Analysis 27:93-115.
https://doi.org/10.1111/j.1538-4632.1995.tb00338.x


