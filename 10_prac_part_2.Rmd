---
title: "R and spatial data: intermediate 2"
author: "Radoslaw Panczak"
date: 2019-02-26
output: 
  html_document: 
    # css: custom.css
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    theme: united 
    highlight: pygments 
---

# Maintenance 

## Restart R session in Rstudio

Use keyboard shortcut `Ctrl + Shift + F10`


## Load the libraries

```{r}
set.seed(1234)

if (!require("tidyverse")) install.packages("tidyverse"); library("tidyverse")
if (!require("sf")) install.packages("sf"); library("sf")
if (!require("tmap")) install.packages("tmap"); library("tmap")

if (!require("spdep")) install.packages("spdep"); library("spdep")

```

## Load the data

```{r}
# raw
listings <- read_csv("./data/listings.csv")

# prepared earlier
SA2_SEIFA_proj <- readRDS("data/SA2_SEIFA.Rds") %>% 
  st_transform(3112) %>% 
  filter(!is.na(IRSAD_s)) %>% 
  as("Spatial")

View(SA2_SEIFA_proj)
View(SA2_SEIFA_proj@data)


```

# Spatial clustering

## Spatial weights

```{r}
weights_queen <- poly2nb(SA2_SEIFA_proj)

summary(weights_queen)

plot(SA2_SEIFA_proj, border = "grey60")
plot(weights_queen, coordinates(SA2_SEIFA_proj), pch = 19, cex = 0.6, add = TRUE)

moran.test(SA2_SEIFA_proj$IRSAD_s, listw = nb2listw(weights_queen))

```


## Global

```{r}
SA2_weights_queen <- poly2nb(SA2_SEIFA_proj)

SA2_weights_queen_list <- nb2listw(SA2_weights_queen, style="W", zero.policy=TRUE)

summary(weights_queen)

plot(SA2_SEIFA_proj, border = "grey60")
plot(weights_queen, coordinates(SA2_SEIFA_proj), pch = 19, cex = 0.6, add = TRUE)

SA2_IRSAD_s_Moran <- moran.test(SA2_SEIFA_proj$IRSAD_s, listw = SA2_weights_queen_list)

SA2_IRSAD_s_Moran

moran.plot(SA2_SEIFA_proj$IRSAD_s, listw = nb2listw(SA2_weights_queen, style = "C"))

SA2_IRSAD_s_Moran_MC <- moran.mc(SA2_SEIFA_proj$IRSAD_s,
                                SA2_weights_queen_list,
                                nsim = 999)

SA2_IRSAD_s_Moran_MC

plot(SA2_IRSAD_s_Moran_MC)


```

## Local

```{r}

SA2_IRSAD_s_lm <- localmoran(SA2_SEIFA_proj$IRSAD_s, listw = SA2_weights_queen_list)

summary(SA2_IRSAD_s_lm)

# manually make a moran plot standarize variables
SA2_SEIFA_proj$IRSAD_s_std <- scale(SA2_SEIFA_proj$IRSAD_s)  #save to a new column

# create a lagged variable
SA2_SEIFA_proj$lag_IRSAD_s <- lag.listw(SA2_weights_queen_list, SA2_SEIFA_proj$IRSAD_s_std)

plot(x = SA2_SEIFA_proj$IRSAD_s_std, y = SA2_SEIFA_proj$lag_IRSAD_s, 
     main = " Moran Scatterplot PPOV")
abline(h = 0, v = 0)
abline(lm(SA2_SEIFA_proj$lag_IRSAD_s ~ SA2_SEIFA_proj$IRSAD_s_std), 
       lty = 3, lwd = 4, col = "red")

```


# Resources

Anselin, L. 1995. Local indicators of spatial association - LISA. Geographical Analysis 27:93-115.
https://doi.org/10.1111/j.1538-4632.1995.tb00338.x

